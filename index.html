<!DOCTYPE html>

<html>
<head>
  <title>CRUDS</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>CRUDS</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><a href="https://travis-ci.org/ksnabb/cruds"><img src="https://travis-ci.org/ksnabb/cruds.png?branch=master" alt="Build Status"></a></p>
<p><strong>CRUDS</strong> aims to provide a fast and easy way to create and expose mongodb 
collections for crud functionality through a RESTful interface and websockets. It also provides
<em>subscribe</em> <em>unsubscribe</em> methods for real-time applications. </p>
<p><strong>CRUDS</strong> depends on <a href="http://expressjs.com">express</a> and <a href="http://socket.io">socket.io</a> to create
the REST and Websocket endpoints. The REST is fully compatible with <a href="http://backbonejs.org">backbone.js</a> models.
All code is released under the MIT license and can be found on <a href="http://github.com/ksnabb/cruds">github</a></p>
<ol>
<li><p>Install with <strong>npm</strong> <code>npm install cruds</code></p>
</li>
<li><p>In your express app <code>cruds = require(&quot;cruds&quot;)(&lt;optional mongodb connection string&gt;)</code></p>
</li>
<li><p>Set endpoints with <code>cruds.set(name, app?, socketio?)</code></p>
</li>
</ol>
<p>The &#39;cruds.set&#39; function will create a socket.io namespace for the passed in name and a REST interface 
under &#39;/name&#39; of which both are optional.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">cruds</span></span> = (connectionString) -&gt;
    mongodb = require <span class="string">"mongodb"</span>
    express = require <span class="string">"express"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><em>_connect(callback)</em> is a helper funtion to connect to
mongodb and to cache the connection. Multiple calls to 
connect will in this way not produce more connections
then one call to connect. The callback function will
receive the mongo database instance object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _mdb = <span class="literal">null</span>

    <span class="function"><span class="title">_connect</span></span> = (callback) -&gt;
        <span class="keyword">if</span> _mdb
            callback _mdb
            <span class="keyword">return</span>

        connectionString = <span class="string">"mongodb://localhost:27017/Entity"</span> <span class="keyword">if</span> <span class="keyword">not</span> connectionString
        mongodb.MongoClient.connect connectionString,  { native_parser: <span class="literal">true</span>, auto_reconnect: <span class="literal">true</span> }, (err, db) =&gt;
            <span class="keyword">if</span> !err
                _mdb = db
                callback _mdb


    <span class="class"><span class="keyword">class</span> <span class="title">Entity</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create an Entity by passing it a name. The RESTful endpoints will be created at &#39;/#{@name}&#39; and the
socket.io namespace will also use the passed in name for the created entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        constructor: (<span class="property">@name</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Handle module internal events with <em>on</em> and <em>trigger</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        listeners: {}

        <span class="literal">on</span>: (eventType, callback) -&gt;
            <span class="keyword">if</span> <span class="property">@listeners</span>[eventType]
                <span class="property">@listeners</span>[eventType].push callback
            <span class="keyword">else</span>
                <span class="property">@listeners</span>[eventType] = [callback]

        trigger: (eventType, args...) -&gt;
            list = <span class="property">@listeners</span>[eventType]
            <span class="keyword">if</span> list
                args.unshift eventType
                <span class="keyword">for</span> listener <span class="keyword">in</span> list
                    listener args...</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><em>exists(query, callback)</em> is a helper function to check if any results exists with the given query. The callback will be called
with true if it exists and with false otherwise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        exists: (query, callback) -&gt;
            _connect (mdb) =&gt;
                mdb.collection <span class="property">@name</span>, (err, col) -&gt;

                    td = col.find(query, {_id: <span class="number">1</span>}).limit <span class="number">1</span>

                    td.count <span class="literal">true</span>, (err, count) -&gt;
                        callback count <span class="keyword">is</span> <span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2>CRUD functions</h2>
<p>The <strong>CRUDS</strong> module exposes functions to do simple crud calls to mongodb collections.</p>
<h3>Create an entity</h3>
<p>The <em>create</em> function takes the following arguments</p>
<ul>
<li><strong>doc</strong> {Object}, The mongodb document to be created</li>
<li><strong>[source]</strong> {Object}, Optional source of the caller of this function</li>
<li><strong>[callback]</strong> {function}, Optional callback function</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        create: (doc, args...) -&gt;

            callback = args.pop() <span class="keyword">or</span> () -&gt;
            source = <span class="keyword">if</span> args.length <span class="keyword">then</span> args.shift() <span class="keyword">else</span> <span class="literal">null</span>

            _connect (mdb) =&gt;
                mdb.collection <span class="property">@name</span>, (err, col) =&gt;
                    <span class="keyword">if</span> !err
                        <span class="function"><span class="title">cb</span></span> = (err, results) =&gt;
                            callback err, results, source
                            <span class="property">@trigger</span> <span class="string">'create'</span>, results, source

                        col.insert doc, cb
                    <span class="keyword">else</span>
                        callback err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>Update an entity</h3>
<p>The <em>update</em> function will update the queried document with the 
key value pairs that is given leaving all non mentioned key value 
pairs untouched.</p>
<ul>
<li><strong>id</strong> {String}, The hexadecimal representation of a mongodb ObjectID    </li>
<li><strong>doc</strong> {Object}, The part of the document that should be updated</li>
<li><strong>[source]</strong> {Object}, Optional source of the caller of this function</li>
<li><strong>[callback]</strong> {function}, callback function     </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        update: (id, doc, args...) -&gt;

            callback = args.pop() <span class="keyword">or</span> () -&gt;
            source = <span class="keyword">if</span> args.length <span class="keyword">then</span> args.shift() <span class="keyword">else</span> <span class="literal">null</span>

            _connect (mdb) =&gt;
                mdb.collection <span class="property">@name</span>, (err, col) =&gt;
                    <span class="keyword">if</span> !err
                        <span class="keyword">delete</span> doc._id
                        oid = <span class="keyword">new</span> mongodb.ObjectID(id)
                        col.update {<span class="string">"_id"</span>: oid}, {$set: doc}, (err, count) =&gt;
                            <span class="keyword">if</span> count <span class="keyword">is</span> <span class="number">0</span>
                                callback {<span class="string">'error'</span>: <span class="number">404</span>}
                            <span class="keyword">else</span>
                                doc._id = oid
                                callback err, doc, source
                                <span class="property">@trigger</span> <span class="string">'update'</span>, [doc], source
                    <span class="keyword">else</span>
                        callback err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>Query entities</h3>
<p>There are two functions to query entities. One takes
and arbitrary mongodb json formated query <em>get</em> and 
the other returns one document according to its id <em>getById</em>.</p>
<p>The get function accepts following arguments:</p>
<ul>
<li><strong>query</strong> {Object}, mongodb query  </li>
<li><strong>options</strong> {Object}, mongodb node.js driver options  </li>
<li><strong>callback</strong> {function}, callback function  </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        get: (query, options, callback) -&gt;

            _connect (mdb) =&gt;
                mdb.collection <span class="property">@name</span>, (err, col) -&gt;
                    <span class="keyword">if</span> !err
                        col.find query, options <span class="keyword">or</span> {}, (err, cursor) -&gt;
                            <span class="keyword">if</span> !err
                                cursor.toArray (err, items) -&gt;
                                    callback err, items
                            <span class="keyword">else</span>
                                callback err, cursor
                    <span class="keyword">else</span>
                        callback err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The <em>getById</em> function returns one item from mongodb
and it accepts the following arguments:</p>
<ul>
<li><strong>id</strong> {String}, id in ObjectId hex representation  </li>
<li><strong>callback</strong> {function}, callback function </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getById: (id, callback) -&gt;
            _connect (mdb) =&gt;
                mdb.collection <span class="property">@name</span>, (err, col) -&gt;
                    <span class="keyword">if</span> !err
                        col.findOne {<span class="string">"_id"</span>: <span class="keyword">new</span> mongodb.ObjectID(id)}, (err, item) -&gt;
                            <span class="keyword">if</span> !item
                                callback err, {}
                            <span class="keyword">else</span>
                                callback err, item
                    <span class="keyword">else</span>
                        callback err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3>Delete entities</h3>
<p>The del function deletes one entity at the time</p>
<ul>
<li><strong>id</strong> {String}, id in hex  </li>
<li><strong>[callback]</strong> {function}, callback function</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        del: (id, callback) -&gt;

            <span class="keyword">if</span> <span class="keyword">not</span> callback
                callback = () -&gt;

            _connect (mdb) =&gt;
                mdb.collection <span class="property">@name</span>, (err, col) =&gt;
                    <span class="keyword">if</span> !err
                        <span class="property">@trigger</span> <span class="string">'delete'</span>, {<span class="string">"_id"</span>: id}
                        col.remove {<span class="string">"_id"</span>: <span class="keyword">new</span> mongodb.ObjectID(id)}, (err) -&gt;
                            callback err
                    <span class="keyword">else</span>
                        callback err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3>Request listener application</h3>
<p>The <em>setApp</em> method sets up a RESTful interface
for the passed express application.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setApp: (<span class="property">@app</span>) -&gt;
            app = express()</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>All messages from and to the RESTful interface are in JSON format and are parsed with the 
bodyParser middleware.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            app.use express.bodyParser()</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h4>URL parameters</h4>
<p>The url parameters are parsed with the help of the parseQuery function.</p>
<p>The URI request takes the following parameters</p>
<ul>
<li><strong>query</strong>, Stringified JSON object that is passed directly to mongodb find as a query parameter  </li>
<li><strong>options</strong>, Stringified JSON object that is passed to the mongodb node.js find function as the options parameter  </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="function"><span class="title">parseQuery</span></span> = (requestParam) -&gt;
                query = {} <span class="comment">#default</span>
                options = {} <span class="comment">#default</span>
                query = JSON.parse requestParam.query <span class="keyword">if</span> requestParam.query
                options = JSON.parse requestParam.options <span class="keyword">if</span> requestParam.options

                {query: query, options: options}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h4>HTTP GET</h4>
<p>Query items by sending query parameters as defined above to the root &quot;/&quot; of the REST interface.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            app.get <span class="string">'/'</span>, (req, res) =&gt;

                q = parseQuery req.query

                <span class="property">@get</span> q.query, q.options, (err, items) -&gt;
                    <span class="keyword">if</span> err
                        res.send <span class="number">400</span>, <span class="string">"something went wrong"</span>
                    <span class="keyword">else</span>
                        res.send items</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Get a single item by sending a GET request to the items url &quot;/:id&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            app.get <span class="string">'/:id'</span>, (req, res) =&gt;

                <span class="property">@getById</span> req.param(<span class="string">'id'</span>), (err, item) -&gt;
                    <span class="keyword">if</span> !err
                        res.send item
                    <span class="keyword">else</span>
                        res.send <span class="number">400</span>, <span class="string">'Something went wrong!'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h4>HTTP Post</h4>
<p>Post to &quot;/&quot; to create a entity. The POST will return the id of the newly created entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            app.post <span class="string">'/'</span>, (req, res) =&gt;

                <span class="property">@create</span> req.body, (err, results) -&gt;
                    <span class="keyword">if</span> !err
                        res.json <span class="number">201</span>, {_id: results[<span class="number">0</span>]._id}
                    <span class="keyword">else</span> 
                        res.json <span class="number">400</span>, {error: <span class="string">'Creating the document did not work!'</span>}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h4>HTTP DELETE</h4>
<p>Delete item by sending http delete to the entity url &quot;/:id&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            app.del <span class="string">'/:id'</span>, (req, res) =&gt;

                <span class="property">@del</span> req.param(<span class="string">'id'</span>), (err) -&gt;
                    <span class="keyword">if</span> !err
                        res.send {}
                    <span class="keyword">else</span>
                        res.send <span class="number">400</span>, <span class="string">"Something went wrong!"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h4>HTTP PUT</h4>
<p>To update send the new values in request body to the entity url &quot;/:id&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            app.put <span class="string">'/:id'</span>, (req, res) =&gt;

                <span class="property">@update</span> req.param(<span class="string">'id'</span>), req.body, (err, doc) =&gt;
                    <span class="keyword">if</span> !err
                        res.json <span class="number">200</span>, <span class="literal">null</span>
                    <span class="keyword">else</span> 
                        res.json <span class="number">404</span>, <span class="string">'Something went wrong!'</span>

            <span class="property">@app</span>.use <span class="string">"/<span class="subst">#{@name}</span>"</span>, app

        setSocketio: (socketio) -&gt;

            namespace = <span class="string">"/<span class="subst">#{@name}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Socket.io rooms are used to handle subscriptions to queries. The handler function
handles create and update events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="function"><span class="title">handler</span></span> = (eventType, results, source) =&gt;

                rooms = socketio.sockets.manager.rooms

                <span class="keyword">for</span> roomid, sockets <span class="keyword">of</span> rooms

                    spl = roomid.split(<span class="string">"/"</span>)
                    <span class="keyword">if</span> spl.length &lt; <span class="number">3</span>
                        <span class="keyword">continue</span>
                    query = spl[spl.length - <span class="number">1</span>]
                    q = JSON.parse query
                    q._id = results[<span class="number">0</span>]._id

                    ((eventType, query, item, instance, socket) -&gt;

                        instance.exists q, (bool) -&gt;

                            <span class="keyword">if</span> bool
                                socket.broadcast
                                    .to(query)
                                    .emit eventType, item

                    )(eventType, query, results[<span class="number">0</span>], @, source)

            <span class="property">@on</span> <span class="string">'create'</span>, handler
            <span class="property">@on</span> <span class="string">'update'</span>, handler

            socketio
                .<span class="keyword">of</span>(namespace)
                .<span class="literal">on</span> <span class="string">'connection'</span>, (socket) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4>socket.io create</h4>
<p>Create documents by sending &#39;create&#39; message together with a JSON object. The emit will
get a response with the id of the newly created entity or an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.<span class="literal">on</span> <span class="string">'create'</span>, (data) =&gt;

                        <span class="property">@create</span> data, socket, (err, results) -&gt;
                            <span class="keyword">if</span> !err
                                socket.emit <span class="string">'create'</span>, {_id: results[<span class="number">0</span>]._id}
                            <span class="keyword">else</span> 
                                socket.emit <span class="string">'create'</span>, {<span class="string">'error'</span>: <span class="number">400</span>}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h4>socket.io udpate</h4>
<p>Update a document by sending a &#39;update&#39; message with an object including a &#39;_id&#39; and the
key values to be updated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.<span class="literal">on</span> <span class="string">'update'</span>, (data) =&gt;

                        id = data._id

                        <span class="keyword">if</span> <span class="keyword">not</span> id
                            socket.emit {<span class="string">'error'</span>: <span class="number">400</span>}
                        <span class="keyword">else</span>
                            <span class="property">@update</span> id, data, socket, (err, count) =&gt;

                                <span class="keyword">if</span> err
                                    socket.emit <span class="string">'update'</span>, err</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h4>socket.io get</h4>
<p>Query documents by sending an object with <em>query</em> and <em>options</em> key value pairs.</p>
<ul>
<li><strong>query</strong> {Object}, mongodb query object</li>
<li><strong>options</strong> {Object}, mongodb options object</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.<span class="literal">on</span> <span class="string">'get'</span>, (data) =&gt;

                        <span class="keyword">if</span> data.query <span class="keyword">and</span> data.query._id
                            data.query._id = <span class="keyword">new</span> mongodb.ObjectID(data.query._id)

                        <span class="property">@get</span> data.query <span class="keyword">or</span> {}, data.options <span class="keyword">or</span> {}, (err, items) -&gt;
                            socket.emit <span class="string">'get'</span>, items</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h4>Socket.io delete</h4>
<p>Delete item by sending an object with the items _id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.<span class="literal">on</span> <span class="string">'delete'</span>, (data) =&gt;
                        <span class="property">@del</span> data._id</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h4>Socket.io subscribe</h4>
<p>Subscribing to entities is done by passing a mongodb query. The socket will
get notifications of events that are returned by the query. The subscription also
handles sending notifications about creation of new documents that fit the query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.<span class="literal">on</span> <span class="string">'subscribe'</span>, (query) -&gt;
                        socket.join JSON.stringify query</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h4>Socket.io unsubscribe</h4>
<p>The unsubscribe works the same way as the subscribe and will unsubscribe from all documents that
fit the query object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.<span class="literal">on</span> <span class="string">'unsubscribe'</span>, (query) -&gt;
                        socket.leave JSON.stringify query</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h4>Socket.io rooms</h4>
<p>To get a list of all rooms currently subscribed to the client can send a getrooms message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.<span class="literal">on</span> <span class="string">'rooms'</span>, -&gt;
                        rooms = socketio.sockets.manager.roomClients[socket.id]
                        socket.emit <span class="string">'rooms'</span>, rooms</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>The disconnect event cleans up the mess.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.<span class="literal">on</span> <span class="string">'disconnect'</span>, -&gt;
                        socket.removeAllListeners()</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3>Setup of url endpoints for REST and websockets</h3>
<p>To be able to set up both a RESTful interface and a websocket interface 
the <em>set</em> method can be used.</p>
<ul>
<li><strong>name</strong> {String}, name of the entity and endpoint url. e.g. if name is &#39;user&#39; the url will be &#39;/user&#39; </li>
<li><strong>app</strong> {Object}, Express application  </li>
<li><strong>socketio</strong> {Object}, Socket.io Server that is set up to listen to a node.js httpserver  </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="title">set</span></span> = (name, app, socketio) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Create the Entity instance that handles the transactions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        entity = <span class="keyword">new</span> Entity(name)</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>If the app is passed as null or undefined a REST interface will not be setup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> app
            entity.setApp app</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Set up the websocket interface and provide the same REST methods <em>get</em>, <em>create</em>, <em>update</em>, <em>delete</em>, <em>subscribe</em> and <em>unsubscribe</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> socketio
            entity.setSocketio socketio</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h3>Exposed functions</h3>
<p>The CRUDS will expose the following methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    set: set
    Entity: Entity

module.exports = cruds</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h1>License</h1>
<p>The MIT License (MIT)</p>
<p>Copyright (c) 2013 Kristoffer Snabb</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
