<!DOCTYPE html>

<html>
<head>
  <title>crud.litcoffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>crud.litcoffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>This module provides three levels of mongodb crud functionality. Simple javascript
functions to access mongodb, a RESTful interface for mongodb using node.js and express app,
and a socket.io interface for crud and subscribe unsubscribe to a mongodb document.</p>
<p>The REST interface is fully compatible with backbone.js models.</p>
<p>To use the module just do require(&quot;cruds&quot;)( mongodb connection string )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>module.<span class="function"><span class="title">exports</span></span> = (mongoDbConnectionString) -&gt;

    MongoClient = require(<span class="string">'mongodb'</span>).MongoClient
    ObjectID = require(<span class="string">'mongodb'</span>).ObjectID</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Functions to return will be created in the &#39;ex&#39; variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ex = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><em>connect(callBack)</em> is a helper funtion to connect to
mongodb and to cache the connection. Multiple calls to 
connect will in this way not produce more connections
then one call to connect. The callback function will
receive the mongo database instance object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    mdb = <span class="literal">null</span>
    listeners = []
    <span class="function"><span class="title">connect</span></span> = (callBack) -&gt;
        <span class="keyword">if</span> mdb
            callBack mdb
            <span class="keyword">return</span>
        <span class="keyword">else</span>
            listeners.push callBack

        mongoDbConnectionString = <span class="string">"mongodb://localhost:27017/Entity"</span> <span class="keyword">if</span> <span class="keyword">not</span> mongoDbConnectionString
        MongoClient.connect mongoDbConnectionString,  { native_parser: <span class="literal">true</span>, auto_reconnect: <span class="literal">true</span> }, (err, db) -&gt;
            <span class="keyword">if</span> !err
                mdb = db

            <span class="keyword">for</span> listener <span class="keyword">in</span> listeners
                listener mdb</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h3>Create an entity</h3>
<p>The function takes the following arguments</p>
<p><em>entityName</em> - string<br><em>entityValue</em> - entity object<br><em>callBack</em> - function     </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ex.<span class="function"><span class="title">create</span></span> = (entityName, entityValue, callBack) -&gt;
        connect (mdb) -&gt;
            mdb.collection entityName, (err, col) -&gt;
                <span class="keyword">if</span> !err
                    col.save entityValue, callBack
                <span class="keyword">else</span>
                    callBack err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3>Update an entity</h3>
<p>The update will update the queried document with the 
key value pairs that is given in entityValue leaving all
non mentioned key value pairs untouched. This function
does in other words not replace the queried documents.</p>
<p>The function takes the following arguments:</p>
<p><em>entityName</em> - The name of the collection to use<br><em>entityId</em> - The hexadecimal representation of a mongodb ObjectID<br><em>entityValue</em> - The part of the document that should be updated<br><em>callBack</em> - function that takes two arguments error if an error occured and count which is the amount of documents that was updated     </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ex.<span class="function"><span class="title">update</span></span> = (entityName, entityId, entityValue, callBack) -&gt;
        connect (mdb) -&gt;
            mdb.collection entityName, (err, col) -&gt;
                <span class="keyword">if</span> !err
                    <span class="keyword">delete</span> entityValue._id
                    col.update {<span class="string">"_id"</span>: <span class="keyword">new</span> ObjectID(entityId)}, {$set: entityValue}, (err, count) -&gt;
                        callBack err, count
                <span class="keyword">else</span>
                    callBack err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>Query entities</h3>
<p>There are two function to query entities. One takes
and arbitrary mongodb json formated query <em>get()</em> and 
the other returns one item by it&#39;s id <em>getById()</em>.</p>
<p>The get function takes the following parameters:</p>
<p><em>entityName</em> - name of entity collection<br><em>query</em> - mongodb query<br><em>options</em> - mongodb node.js driver options<br><em>callBack</em> - callback function  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ex.<span class="function"><span class="title">get</span></span> = (entityName, query, options, callBack) -&gt;

        connect (mdb) -&gt;
            mdb.collection entityName, (err, col) -&gt;
                <span class="keyword">if</span> !err
                    col.find query, options <span class="keyword">or</span> {}, (err, cursor) -&gt;
                        <span class="keyword">if</span> !err
                            cursor.toArray (err, items) -&gt;
                                callBack err, items
                        <span class="keyword">else</span>
                            callBack err, cursor
                <span class="keyword">else</span>
                    callBack err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The <em>getById</em> function returns one item from mongodb
and it takes the following parameters:</p>
<p><em>entityName</em> - name of entity collection<br><em>id</em> - id in OjectId hex representation<br><em>callBack</em> - The callback function that gets error object and item as parameters  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ex.<span class="function"><span class="title">getById</span></span> = (entityName, id, callBack) -&gt;
        connect (mdb) -&gt;
            mdb.collection entityName, (err, col) -&gt;
                <span class="keyword">if</span> !err
                    col.findOne {<span class="string">"_id"</span>: <span class="keyword">new</span> ObjectID(id)}, (err, item) -&gt;
                        <span class="keyword">if</span> !item
                            callBack err, {}
                        <span class="keyword">else</span>
                            callBack err, item
                <span class="keyword">else</span>
                    callBack err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>Delete entities</h3>
<p>The del function deletes one entity</p>
<p><em>entityName</em> - name of entity collection<br><em>id</em> - id in hex<br><em>callBack</em> - callback that gets an error object as parameter  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ex.<span class="function"><span class="title">del</span></span> = (entityName, id, callBack) -&gt;
        connect (mdb) -&gt;
            mdb.collection entityName, (err, col) -&gt;
                <span class="keyword">if</span> !err
                    col.remove {<span class="string">"_id"</span>: <span class="keyword">new</span> ObjectID(id)}, (err) -&gt;
                        callBack err
                <span class="keyword">else</span>
                    callBack err, col</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>Request listener application</h3>
<p>The following module.export returns an express app
that provides the REST interface for an Entity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ex.<span class="function"><span class="title">getApp</span></span> = (name) -&gt;
        express = require(<span class="string">'express'</span>)
        app = express()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The application requires json parser or bodyparser middleware to work.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        app.use express.bodyParser()</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The GET parameters are parsed with the help of the parseQuery function.
The URI request can have the following parameters:
<em>query</em> - Stringified JSON object that is passed directly to mongodb find as query parameter<br><em>options</em> - Stringified JSON object that is the options for nodejs mongodb driver find function  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="function"><span class="title">parseQuery</span></span> = (requestParam) -&gt;
            query = {} <span class="comment">#default</span>
            options = {} <span class="comment">#default</span>
            query = JSON.parse requestParam.query <span class="keyword">if</span> requestParam.query
            options = JSON.parse requestParam.options <span class="keyword">if</span> requestParam.options

            {query: query, options: options}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Query items by sending query parameters as defined above to the root of the REST interface.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        app.get <span class="string">'/'</span>, (req, res) -&gt;

            q = parseQuery req.query

            ex.get name, q.query, q.options, (err, items) -&gt;
                <span class="keyword">if</span> err
                    res.send <span class="number">400</span>, <span class="string">"something went wrong"</span>
                <span class="keyword">else</span>
                    res.send items</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Get a single item by sending a GET request to the items url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        app.get <span class="string">'/:id'</span>, (req, res) -&gt;

            ex.getById name, req.param(<span class="string">'id'</span>), (err, item) -&gt;
                <span class="keyword">if</span> !err
                    res.send item
                <span class="keyword">else</span>
                    res.send <span class="number">400</span>, <span class="string">'Something went wrong!'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Post to create a entity. The JSON object of the entity is sent in request body</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        app.post <span class="string">'/'</span>, (req, res) -&gt;

            ex.create name, req.body, (err, item) -&gt;
                <span class="keyword">if</span> !err
                    res.send item
                <span class="keyword">else</span> 
                    res.send <span class="number">400</span>, <span class="string">'Something went wrong!'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Delete item by sending http delete to the entity url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        app.del <span class="string">'/:id'</span>, (req, res) -&gt;

            ex.del name, req.param(<span class="string">'id'</span>), (err) -&gt;
                <span class="keyword">if</span> !err
                    res.send {}
                <span class="keyword">else</span>
                    res.send <span class="number">400</span>, <span class="string">"Something went wrong!"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>To update send the new values in request body to the entity url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        app.put <span class="string">'/:id'</span>, (req, res) -&gt;

            ex.update name, req.param(<span class="string">'id'</span>), req.body, (err, count) -&gt;

                <span class="keyword">if</span> !err <span class="keyword">and</span> count <span class="keyword">is</span> <span class="number">1</span>
                    ex.getById name, req.param(<span class="string">'id'</span>), (err, item) -&gt;
                        <span class="keyword">if</span> !err
                            res.send item
                        <span class="keyword">else</span>
                            res.send <span class="number">400</span>, <span class="string">'Something went wrong!'</span>
                <span class="keyword">else</span> <span class="keyword">if</span> count <span class="keyword">is</span> <span class="number">0</span>
                    res.send <span class="number">404</span>
                <span class="keyword">else</span> 
                    res.send <span class="number">400</span>, <span class="string">'Something went wrong!'</span>

        app</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3>Set up of url endpoints</h3>
<p>To be able to set up both a RESTful interface and a websocket interface 
the <em>set</em> method can be used. </p>
<p><em>url</em> - endpoint for the request<br><em>name</em> - name of the entity to use for saving to the database<br><em>app</em> - Express application<br><em>socketio</em> - Socket.io that is set up to listen to a node.js httpserver  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ex.<span class="function"><span class="title">set</span></span> = (url, name, app, socketio) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Set up the REST interface using getApp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        app.use url, ex.getApp(name)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Set up the websocket interface and provide the same REST methods <em>get</em>, <em>create</em>, <em>update</em>, <em>delete</em>, <em>subscribe</em> and <em>unsubscribe</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        socketio
            .<span class="keyword">of</span>(url)
            .<span class="literal">on</span> <span class="string">'connection'</span>, (socket) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Create documents by sending &#39;create&#39; message together with a JSON object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                socket.<span class="literal">on</span> <span class="string">'create'</span>, (data) -&gt;

                    ex.create name, data, (err, item) -&gt;
                        <span class="keyword">if</span> !err
                            socket.emit <span class="string">'create'</span>, data
                        <span class="keyword">else</span> 
                            socket.emit <span class="string">'create'</span>, {<span class="string">'error'</span>: <span class="number">400</span>}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Update a document by sending a &#39;update&#39; message with an object including and &#39;_id&#39; and the
key values to be updated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                socket.<span class="literal">on</span> <span class="string">'update'</span>, (data) -&gt;

                    id = data._id

                    <span class="keyword">if</span> <span class="keyword">not</span> id
                        socket.emit {<span class="string">'error'</span>: <span class="number">400</span>}
                    <span class="keyword">else</span>
                        ex.update name, id, data, (err, count) -&gt;

                            <span class="keyword">if</span> !err <span class="keyword">and</span> count <span class="keyword">is</span> <span class="number">1</span>
                                ex.getById name, id, (err, item) -&gt;
                                    <span class="keyword">if</span> !err
                                        socket.emit <span class="string">'update'</span>, item
                                        socketio.<span class="keyword">of</span>(url).<span class="keyword">in</span>(item._id).emit <span class="string">'supdate'</span>, item
                                    <span class="keyword">else</span>
                                        socket.emit <span class="string">'update'</span>, {<span class="string">'error'</span>: <span class="number">400</span>}
                            <span class="keyword">else</span> <span class="keyword">if</span> count <span class="keyword">is</span> <span class="number">0</span>
                                socket.emit <span class="string">'update'</span>, {<span class="string">'error'</span>: <span class="number">404</span>}
                            <span class="keyword">else</span>
                                socket.emit <span class="string">'update'</span>, {<span class="string">'error'</span>: <span class="number">400</span>}

                socket.<span class="literal">on</span> <span class="string">'get'</span>, (data) -&gt;

                    ex.get name, data.query <span class="keyword">or</span> {}, data.options <span class="keyword">or</span> {}, (err, items) -&gt;
                        socket.emit <span class="string">'get'</span>, items

                socket.<span class="literal">on</span> <span class="string">'delete'</span>, (data) -&gt;

                    ex.del name, data._id, (err) -&gt;

                        socket.emit <span class="string">'delete'</span>, {}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Subscribing to entities is done by sending &#39;subscribe&#39; together with query object. The
returned documents for the query will be subscribed to for updates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                socket.<span class="literal">on</span> <span class="string">'subscribe'</span>, (data) -&gt;

                    ex.get name, data <span class="keyword">or</span> {}, {fields: [{_id: <span class="number">1</span>}]}, (err, items) -&gt;
                        <span class="keyword">for</span> item <span class="keyword">in</span> items
                            socket.join item._id
                            socket.emit <span class="string">'subscribed'</span>, item</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>The unsubscribe works the same way as the subscribe and will unsubscribe from all documents that
fit the query object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                socket.<span class="literal">on</span> <span class="string">'unsubscribe'</span>, (data) -&gt;

                    ex.get name, data <span class="keyword">or</span> {}, {fields: [{_id: <span class="number">1</span>}]}, (err, items) -&gt;
                        <span class="keyword">for</span> item <span class="keyword">in</span> items
                            socket.leave item._id


    ex</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
